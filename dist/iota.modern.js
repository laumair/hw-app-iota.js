import e from"struct";import r from"iota.lib.js/lib/crypto/bundle/bundle.js";import{addChecksum as t,transactionTrytes as a,noChecksum as s}from"iota.lib.js/lib/utils/utils.js";import n from"bip32-path";import i from"semver";import d from"joi";function o(){return(o=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}const u=d.number().integer(),c=u.min(1).max(3),l=u.min(0).max(4294967295),h=u.min(0).max(0x9dff7d32d5dc1),p=u.min(1).max(0x9dff7d32d5dc1),f=d.string().regex(/^[A-Z9]+$/),g=f.allow("").max(27),_=d.alternatives().try(f.length(81),f.length(90)),m=d.array().items(d.object({address:_.required(),tag:g.required(),value:h.required()}).unknown()).min(1),w=d.array().items(d.object({address:_.required(),balance:p.required(),keyIndex:l.required()}).unknown()).min(1),y=d.object({address:_.required(),keyIndex:l.required()}).unknown(),x="9".repeat(27);class v{constructor(e){e.decorateAppAPIMethods(this,["setActiveSeed","getAddress","prepareTransfers","getAppVersion","getAppMaxBundleSize","signBundle"],"IOT"),this.transport=e,this.config=void 0,this.security=0,this.pathArray=void 0}async setActiveSeed(e,r=2){d.assert(e,d.string().required()),d.assert(r,c.required()),this.pathArray=v._validatePath(e),this.security=r,this.config=this.config?this.config:await this._getAppConfig(),i.satisfies(this.config.app_version,"<0.5")?(this._createPubkeyInput=this._createPubkeyInputLegacy,this._createTxInput=this._createTxInputLegacy,await this._setSeed()):await this._reset(!0)}async getAddress(e,r={}){this._assertInitialized(),d.assert(e,l.required());const a=r.checksum||!1,s=r.display||!1,n=await this._publicKey(e,s);return a?t(n):n}async prepareTransfers(e,r,t,a=(()=>Date.now())){if(this._assertInitialized(),d.assert(e,m.required()),d.assert(r,w.required()),d.assert(t,y.optional()),d.assert(a,d.func().arity(0).required()),1!=e.length)throw new Error("unsupported number of transfers");t=v._validateRemainder(e,r,t);const s=await this._prepareTransfers(e,r,t,a);return await this._reset(!0),s}async signBundle(e,r){e.finalize(),e.bundle.filter(e=>e.value<0).forEach(e=>{if(!(e.address in r))throw new Error('"addressKeyIndices" invalid: missing '+e.address)});try{await this._signBundle(e,r)}catch(e){throw console.error(e),new Error(e)}const t=[];return e.bundle.forEach(e=>t.push(a(e))),t.reverse()}async getAppVersion(){const e=await this._getAppConfig();return this.config=e,e.app_version}async getAppMaxBundleSize(){const e=await this._getAppConfig();return this.config=e,e.app_max_bundle_size?e.app_max_bundle_size:8}static _validatePath(e){let r;try{r=n.fromString(e).toPathArray()}catch(e){throw new Error('"path" invalid: '+e.message)}if(!r||r.length<2||r.length>5)throw new Error('"path" invalid: Invalid path length');return r}_assertInitialized(){if(!this.security)throw new Error("seed not yet initialized")}_addSeedFields(e){return e.word8("security").word32Ule("pathLength").array("pathArray",this.pathArray.length,"word32Ule")}_initSeedFields(e){const r=e.fields;r.security=this.security,r.pathLength=this.pathArray.length,r.pathArray=this.pathArray}async _setSeed(){const r=new e;this._addSeedFields(r),r.allocate(),this._initSeedFields(r),await this._sendCommand(1,0,0,r.buffer(),1e4)}_createPubkeyInputLegacy(r){let t=new e;return t=t.word32Ule("index"),t.allocate(),t.fields.index=r,t}_createPubkeyInput(r){let t=new e;return this._addSeedFields(t),t=t.word32Ule("index"),t.allocate(),this._initSeedFields(t),t.fields.index=r,t}async _publicKey(r,t){const a=this._createPubkeyInput(r),s=await this._sendCommand(2,t?1:0,0,a.buffer(),1e4),n=(new e).chars("address",81);return n.setBuffer(s),n.fields.address}static _validateRemainder(e,r,t){const a=r.reduce((e,r)=>e+r.balance,0),s=e.reduce((e,r)=>e+r.value,0);if(a<s)throw new Error("insufficient balance");if(a>s){if(!t)throw new Error('"remainder" is required');return{address:t.address,value:a-s,keyIndex:t.keyIndex}}}async _sign(r,t){const a=(new e).word32Ule("index");a.allocate(),a.fields.index=r;const s=await this._sendCommand(4,0,0,a.buffer(),1e4),n=(new e).chars("signature",t).word8Sle("fragmentsRemaining");return n.setBuffer(s),{signature:n.fields.signature,fragmentsRemaining:n.fields.fragmentsRemaining}}_createTxInputLegacy(r,t,a,s,n,i,d){let o=new e;o=o.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time"),o.allocate();const u=o.fields;return u.address=r,u.address_idx=t,u.value=a,u.tag=s,u.tx_idx=n,u.tx_len=i,u.time=d,o}_createTxInput(r,t,a,s,n,i,d){let o=new e;0==n&&this._addSeedFields(o),o=o.chars("address",81).word32Ule("address_idx").word64Sle("value").chars("tag",27).word32Ule("tx_idx").word32Ule("tx_len").word32Ule("time"),o.allocate(),0==n&&this._initSeedFields(o);const u=o.fields;return u.address=r,u.address_idx=t,u.value=a,u.tag=s,u.tx_idx=n,u.tx_len=i,u.time=d,o}async _transaction(r,t,a,s,n,i,d){const o=this._createTxInput(r,t,a,s,n,i,d);let u=1e4;n==i&&(u=15e4);const c=await this._sendCommand(3,0==n?0:128,0,o.buffer(),u),l=(new e).word8("finalized").chars("bundleHash",81);return l.setBuffer(c),{finalized:l.fields.finalized,bundleHash:l.fields.bundleHash}}async _getSignatureFragments(e,r){const t=2187*this.security/r;let a="";for(let s=1;s<=t;s++){const n=await this._sign(e,r);if(a+=n.signature,s===t!=(0===n.fragmentsRemaining))throw new Error("wrong signture length")}return a.match(/.{2187}/g)}async _addSignatureFragmentsToBundle(e){for(let r=0;r<e.bundle.length;r++){const t=e.bundle[r];if(t.value>=0)continue;const a=await this._getSignatureFragments(r,243);t.signatureMessageFragment=a.shift();const s=t.address;for(let t=1;t<this.security;t++){if(++r>=e.bundle.length)return;const t=e.bundle[r];t.address===s&&0===t.value&&(t.signatureMessageFragment=a.shift())}}}async _signBundle(e,r){let t=!1,a="";for(const s of e.bundle){const e=r[s.address]?r[s.address]:0,n=await this._transaction(s.address,e,s.value,s.obsoleteTag,s.currentIndex,s.lastIndex,s.timestamp);t=n.finalized,a=n.bundleHash}if(!t)throw new Error("bundle not finalized");if(a!==e.bundle[0].bundle)throw new Error("wrong bundle hash");await this._addSignatureFragmentsToBundle(e)}_hasDuplicateAddresses(e,r,t){const a=new Set;return e.forEach(e=>a.add(e.address)),r.forEach(e=>a.add(e.address)),!(!t||!a.has(t.address))||a.length===e.length+r.length}async _prepareTransfers(e,t,n,i){if(e=e.map(e=>o({},e,{address:s(e.address),tag:e.tag?e.tag.padEnd(27,"9"):x})),t=t.map(e=>o({},e,{address:s(e.address),security:this.security})),n&&(n=o({},n,{address:s(n.address)})),this._hasDuplicateAddresses(e,t,n))throw new Error("transaction must not contain duplicate addresses");const d=Math.floor(i()/1e3);let u=new r;e.forEach(e=>u.addEntry(1,e.address,e.value,e.tag,d,-1)),t.forEach(e=>u.addEntry(e.security,e.address,-e.balance,x,d,e.keyIndex)),n&&u.addEntry(1,n.address,n.value,x,d,n.keyIndex),u.addTrytes([]),u.finalize();const c={};t.forEach(e=>c[e.address]=e.keyIndex),n&&(c[n.address]=n.keyIndex),await this._signBundle(u,c);const l=[];return u.bundle.forEach(e=>l.push(a(e))),l.reverse()}_createAppConfigOutputLegacy(){return(new e).word8("app_flags").word8("app_version_major").word8("app_version_minor").word8("app_version_patch")}_createAppConfigOutput(){return(new e).word8("app_version_major").word8("app_version_minor").word8("app_version_patch").word8("app_max_bundle_size").word8("app_flags")}async _getAppConfig(){const e=await this._sendCommand(16,0,0,void 0,1e4);let r=this._createAppConfigOutput();e.length<r.length()+2&&(r=this._createAppConfigOutputLegacy()),r.setBuffer(e);const t=r.fields;return{app_max_bundle_size:t.app_max_bundle_size,app_flags:t.app_flags,app_version:t.app_version_major+"."+t.app_version_minor+"."+t.app_version_patch}}async _reset(e=!1){await this._sendCommand(255,e?1:0,0,void 0,1e4)}async _sendCommand(e,r,t,a,s){const n=this.transport;try{return n.setExchangeTimeout(s),await n.send(122,e,r,t,a)}catch(e){throw e.statusCode&&(e.message=function(e){const r=function(e){switch(e){case 36864:return"Success";case 26368:return"Incorrect input length";case 27264:return"Incorrect data";case 27392:return"Incorrect command parameter";case 27648:return"Incorrect length specified in header";case 27904:return"Invalid INS command";case 28160:return"Incorrect CLA (Wrong application opened)";case 26880:return"Command not allowed (Command out of order)";case 27010:return"Security not satisfied (Device locked)";case 27013:return"Condition of use not satisfied (Denied by the user)";case 25601:return"Security not satisfied (Timeout exceeded)";case 27041:return"Bundle error (Insecure hash)";case 27042:return"Bundle error (Non zero balance)";case 27043:return"Bundle error (Invalid meta transaction)";case 27044:return"Bundle error (Invalid input address/index pair(s))";case 27045:return"Bundle error (Address reused)";case 27012:return"Invalid input data";case 27014:return"App has not been initialized by user";case 27025:return"Invalid transaction index";case 27026:return"Invalid transaction order (Output, Inputs, Change)";case 27027:return"Invalid meta transaction";case 27028:return"Invalid output transaction (Output must come first)"}if(28416<=e&&e<=28671)return"Internal error, please report"}(e);if(r)return`Ledger device: ${r} (0x${e.toString(16)})`}(e.statusCode)||e.message),e}}}export default v;
//# sourceMappingURL=iota.modern.js.map
